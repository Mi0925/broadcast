<div class="gb-table">
	<div class="taskmsg" id="table-main">
		<div class="tkrange">
			<div class="tklay">
				<span class="talay-word"><i class="iconfont icon-rili"></i>发布时间</span>
				<div class="layui-input-inline">
			        <input type="text" class="layui-input" id="daterg" placeholder="选择时间范围">
			        <span class="tocho iconfont icon-shijian" id="tochobtn"></span> 
		    	</div>
		    	<div class="newtk-btn" id="tochocase">
		    		<span class="catonew">新建演练消息<i class="iconfont icon-arrow-bottom"></i></span>
		    		<ul class="tonewlist">
		    			<li>
		    				<a href="#/newManualExerProg" class="newtk-btn add_tab" url="components/newManualExerProg.html" name="新建手动演练计划">新建手动演练计划</a>
		    			</li>
		    			<li>
		    				<a href="#/newCyclePlan" class="newtk-btn add_tab" url="components/newCyclePlan.html" name="新建周期性计划">新建周期性计划</a>
		    			</li>
		    		</ul>
		    	</div>
			</div>
			<div class="tksearch">
				<input type="text" value="请输入演练消息的名称，发布部门，负责人" onfocus="if(this.value==defaultValue){this.value = '';this.style.color='#333'}" onblur="if(!value){this.value = defaultValue;this.style.color='#ccc';}" class="dsearch" aria-controls="table-main"/>
				<span class="tksrh-btn"><i class="iconfont icon-sousuo"></i></span>
			</div>
			<ul class="msgtype">
				<li class="msgact">已查阅</li>
				<li>未查阅</li>
				<li>新编辑</li>
			</ul>
		</div>
		<div class="thetab">
			<div class="tablecont">
			    <table class="table-main display" cellspacing="0" width="100%">
			        <thead>
				        <tr>
				        	<th></th>
				            <th>序号</th>
				            <th>状态监测</th>
				            <th>计划类型</th>
				            <th>消息等级</th>
				            <th>演练计划名称</th>
				            <th>发布部门</th>
				            <th>负责人</th>
				            <th>发布时间</th>
				            <th>操作</th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				        </tr>
			        </thead>
			        <tfoot>
				        <tr>
							<th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				            <th></th>
				        </tr>
			        </tfoot>
			        <tbody>
			        </tbody>
			    </table>
			</div>
			<div class="theche">
				<div class="tocheck">
					<input type="checkbox" name="checkall" id="checkAll" />
					<label for="checkAll">全选</label>
				</div>
				<span class="chedel j-del-tr"><i class="iconfont icon-shanchu"></i>删除</span>
			</div>
		</div>
		<p class="botword">© 2017-2018 浙江省应急广播平台</p>
	</div>
	

	<div class="popwindow"></div>
	<div class="preview">
		<p class="poptit">预览</p>
		<span class="popclose"><i class="iconfont icon-guanbi"></i></span>
		<div class="prevcont">
			<ul class="prevlist">
				<li>
					<p class="prevword">文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息文本信息...</p>
					<input type="button" value="预览" class="tosee" />
				</li>
				<li>
					<p class="prevideo">视频.mp4</p>
					<input type="button" value="预览" class="tosee" />
				</li>
				<li>
					<p class="prevideo">文本.txt</p>
					<input type="button" value="预览" class="tosee" />
				</li>
			</ul>
			<input type="button" value="全部预览" class="seeall" />
		</div>
	</div>
	</div>
	<div class="review">
		<p class="poptit">是否通过审核？</p>
		<span class="popclose"><i class="iconfont icon-guanbi"></i></span>
		<div class="revcont">
			<p class="revword">通过的任务消息将进入发布队列，您没有权限进行停止等操作。</p>
			<div class="revbtn">
				<input type="button" value="否" class="revno"/>
				<input type="button" value="是" class="revyes j-audit-yes"/>
			</div>
		</div>
	</div>
	<div class="fillin">
		<p class="poptit">请填写未通过原因！</p>
		<span class="popclose"><i class="iconfont icon-guanbi"></i></span>
		<div class="fillcnt">
			<script type="text/plain" id="myEditor" style="width:100%;height:164px;"></script>
			<div class="revbtn">
				<input type="button" value="取消" class="rev-cancel"/>
				<input type="button" value="确定" class="revyes j-audit-no"/>
			</div>
		</div>
	</div>
	<div class="unreason">
		<p class="poptit">未通过原因</p>
		<span class="popclose"><i class="iconfont icon-guanbi"></i></span>
		<div class="uncont">
			<p class="unword">未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因未通过原因</p>
			<input type="button" value="确定" class="un-confirm" />
		</div>
	</div>
	<div class="choose">
		<p class="choword">确定删除此任务消息吗？</p>
		<div class="chobtn">
			<input type="button" value="删除" class="chopri j-del-tr" />
			<input type="button" value="取消" class="cho-cancel" />
		</div>
		<span class="triangle"><em></em></span>
	</div>
</div>
	



<script type="text/javascript">
	$(document).ready(function(){
		//富文本框
		var editorOption = {
		    scaleEnabled:true
		};
		var editor_a = new baidu.editor.ui.Editor(editorOption);
		editor_a.render('myEditor');
		/*table*/
       	var table = $('#table-main table').DataTable({
           	"scrollY": "calc(100% - 50px)",
		   	"scrollX": true,
           	"dom": '<"top"f >rt<"bottom"ilp><"clear">',//dom定位
           	"dom": 'tiprl',//自定义显示项
           	"lengthMenu":[10, 20, 30, 40, 50],//每页显示条数设置
           	"lengthChange": true,//是否允许用户自定义显示数量
           	"bPaginate": true, //翻页功能
           	"bFilter": true, //列筛序功能
           	"searching": true,//本地搜索
           	"order": [ 1, "asc" ],//desc降序
           	"Info": true,//页脚信息
           	"oLanguage": oLanguage,
            "ajax": {
			    url: portsrc+'/practice/all',
			    type: 'post',
			    data:{
			    	token:token,
			    },
	            dataSrc: function ( data ) {
	                for ( var i=0, ien=data.body.length ; i<ien ; i++ ) {
	                	var d=data.body[i];
	                	data.body[i].checkbox="<div class='checkone'><input type='checkbox' name='checkone' id='"+d.id+"' /><label for='"+d.id+"'></label></div>";//复选框
	                	data.body[i].tabnumb="<span class='tabnumb'>"+(d.id+1)+"</span>";//序号

	                	var level="";
						if(d.level=="红色"){
							level="<img src='src/images/rank-red.png'/>";
						} else if(d.level=="蓝色"){
							level="<img src='src/images/rank-blue.png'/>";
						} else if(d.level=="绿色"){
							level="<img src='src/images/rank-green.png'/>";
						} else if(d.level=="橙色"){
							level="<img src='src/images/rank-orange.png'/>";
						} else if(d.level=="黄色"){
							level="<img src='src/images/rank-yellow.png'/>";
						}
	                	data.body[i].level='<span class="rankimg" vel="'+d.level+'">'+level+'</span>';

	                	if(d.type=='周期'){
	                		data.body[i].name="<a href='#/viewCyclePlan' url='components/viewCyclePlan.html' class='view-cont add_tab' name='查看周期性计划'>"+d.name+"</a>";
	                	}else{
	                		data.body[i].name="<a href='#/viewManualExerProg' url='components/viewManualExerProg.html' class='view-cont add_tab' name='查看手动计划'>"+d.name+"</a>";
	                	}
	                	

	                	data.body[i].yulan="<span class='operbtn'><i class='iconfont icon-yulan'></i>预览</span>";

	                	if(d.type=='周期'){
	                		data.body[i].edit="<a href='#/editCyclePlan' url='components/editCyclePlan.html' class='editbtn add_tab' name='编辑周期性计划'><i class='iconfont icon-bianji'></i>编辑</a>";
	                	}else{
	                		data.body[i].edit="<a href='#/editManualExerProg' url='components/editManualExerProg.html' class='editbtn add_tab' name='编辑手动演练计划'><i class='iconfont icon-bianji'></i>编辑</a>";
	                	}
	                	
	                	data.body[i].release="<a href='#/planReleasePolicy' class='issue isstr add_tab' url='components/PlanReleasePolicy.html' name='发布策略'><i class='iconfont icon-fabu'></i>发布策略</a>";

	                	var audit="";
						if(d.audit.boolean==true){
							if(d.audit.state=='审核'){
								if(d.type=='周期'){
			                		audit="<span class='check audit j-resend-cycle' lay-event='audit'><i class='iconfont icon-shenhe'></i>审核</span>";
			                	}else{
			                		audit="<span class='check audit j-resend-manual' lay-event='audit'><i class='iconfont icon-shenhe'></i>审核</span>";
			                	}
							}else if(d.audit.state=='未通过'){
								if(d.type=='周期'){
			                		audit="<span class='check notpass j-resend-cycle' lay-event='nopass'><i class='iconfont icon-weitongguo'></i>未通过</span>";
			                	}else{
			                		audit="<span class='check notpass j-resend-manual' lay-event='nopass'><i class='iconfont icon-weitongguo'></i>未通过</span>";
			                	}
							}
						};
	                	data.body[i].audit=audit;

	                	var send="";
						if(d.send.boolean==true){
							if(d.send.state=='续发'){
								send="<a href='javascript:void(0);' class='issue iscont'><i class='iconfont icon-bofang'></i>续发</a>";
							}else if(d.send.state=='停发'){
								send='<a href="javascript:void(0);" class="issue isstop"><i class="iconfont icon-zanting"></i>停发</a>';
							}
						};
	                	data.body[i].send=send;

	                	if(d.type=='周期'){
	                		data.body[i].chretry="<span class='check chretry j-resend-cycle'><i class='iconfont icon-zhongbo'></i>重播</span>";
	                	}else{
	                		data.body[i].chretry="<span class='check chretry j-resend-manual'><i class='iconfont icon-zhongbo'></i>重播</span>";
	                	}
	                	
	                	data.body[i].decancel="<span class='del decancel'><i class='iconfont icon-quxiao'></i>取消</span>";

	                	if(d.type=='周期'){
	                		data.body[i].delete="<span class='del delete j-resend-cycle'><i class='iconfont icon-shanchu'></i>删除</span>";
	                	}else{
	                		data.body[i].delete="<span class='del delete j-resend-manual'><i class='iconfont icon-shanchu'></i>删除</span>";
	                	}
	                	
	                }
	                
	                return data.body;
	            }
	        },
			"columns": [
			    { "data": "checkbox" },
			    { "data": "tabnumb" },
			    { "data": "state" },
			    { "data": "type" },
			    { "data": "level" },
			    { "data": "name" },
			    { "data": "department" },
			    { "data": "people" },
			    { "data": "time" },
			    { "data": "yulan" },
			    { "data": "edit" },
			    { "data": "release" },
			    { "data": "audit" },
			    { "data": "send" },
			    { "data": "chretry" },
			    { "data": "decancel" },
			    { "data": "delete" }
			],
            "columnDefs": [
           		{
                   orderable: false,
                   targets: [0,2,3,4,5,6,7,9,10,11,12,13,14,15,16] //禁止排序
                },{ 
                	"sType": "html-percent", 
                   "aTargets": [4] //指定列号使用自定义排序
                }   
            ],
            fnDrawCallback: function(table) {  
           		jumpPage($("#table-main"))
            },
            initComplete: function () {//列筛选
               var api = this.api();
               api.columns().indexes().flatten().each(function (i) {
                   var column = api.column(i);
                    if (i == 2 || i == 3 || i == 6 || i == 7) { //对第i列进行筛选
							rowScreen(column);
                    }else if (i==4) { //对第i列进行筛选
							rowLevScreen(column);
                    }
               });
            }
		})
		userDef(table);//table配置--显示数量 搜索 全选 删除

		// 已查阅,未查阅，新编辑
	    $('body').on('click','.msgtype li',function() {
	    	var defaulrValue=0;
	    	if($(this).text()=='已查阅'){
	    		defaulrValue=0;
	    	}else if($(this).text()=='未查阅'){
	    		defaulrValue=1;
	    	}else if($(this).text()=='新编辑'){
	    		defaulrValue=2;
	    	}
	    	var param={
			    	token:token,
			    	defaulrValue:defaulrValue,
			    };
			table.settings()[0].ajax.data = param;
			table.ajax.reload();
	    });

	    var prog_type='',//manual为手动，cycle为周期
	    	resend_type='';
	    $('body').on('click','.j-resend-manual',function() {
			prog_type='manual';
			resend_type='manualPractice';
			console.log(prog_type);
	    });
	    $('body').on('click','.j-resend-cycle',function() {
			prog_type='cycle';
			resend_type='cyclePractice';
			console.log(prog_type);
	    });
		// 删除
	    $('body').on('click','.j-del-tr',function() {
			var deleteId=[];//存放删除id
	        $('tr.selected').each(function() {
	            deleteId.push($(this).find('.checkone').find('input').attr('id'));
	        });
	        // 模拟数据
	        $.ajax({
	            url: portsrc + '/practice/delete/PracticeMsg',
	            type: 'get',
	            dataType: 'json',
	            data: {
	                token:token,
	                type:'prog_type',
	                id: deleteId.sort()
	            },
	            success: function(data) {
	                tr_del(table);
	                deleteId=[];
	            }
	        });
	    });

	    // 重播
	    $('body').on('click','.cho-again',function(){
	        // 模拟数据
	        $.ajax({
	            url: portsrc + '/practice/resend',
	            type: 'get',
	            dataType: 'json',
	            data: {
	                token:token,
	                type:prog_type,
	                id: sessionStorage.getItem('chretry')
	            },
	            success: function(data) {
	                layer.open({
	                    title: '提示',
	                    content: '重播成功'
	                });
	            }
	        });
	    });

	    // 审核未通过
	    $('body').on('click','.notpass',function(){
	        // 模拟数据
	        $.ajax({
	            url: portsrc + '/unpassreason',
	            type: 'get',
	            dataType: 'json',
	            data: {
	                token:token,
	                type:resend_type,
	                id:$(this).find('.checkone').find('input').attr('id')
	            },
	            success: function(data) {
	                $(".unword").text(data.body);
	            }
	        });
	    });

	    // 审核通过
	    $('body').on('click','.j-audit-yes',function(){
	        $.ajax({
	            url: portsrc + '/messageAudit',
	            type: 'get',
	            dataType: 'json',
	            data: {
	                token:token,
	                type:resend_type,
			    	pass:true,//是否通过
	            },
	            success: function(data) {
	                layer.open({
	                    title: '提示',
	                    content: '审核通过'
	                });
	            }
	        });
	    });

	    // 审核不通过
	    $('body').on('click','.j-audit-no',function(){
	        $.ajax({
	            url: portsrc + '/messageAudit',
	            type: 'get',
	            dataType: 'json',
	            data: {
	                token:token,
	                type:resend_type,
			    	pass:false,//是否通过
			    	require:editor_a.getPlainTxt()//未通过理由
	            },
	            success: function(data) {
	                layer.open({
	                    title: '提示',
	                    content: '审核通过'
	                });
	            }
	        });
	    })
	})
</script>